<html>
<head>
    <title>Projeto-Video</title>
<style>
    html, body {
        max-height: 100vh;
        max-width: 100vw;
        border: 0;
        outline: 0;
        margin: 0;
        box-sizing: content-box;
    }

    body {
        background-color: #181818;
        color: #f0f0f0;
        display: flex;
    }

    video, canvas {
        flex: 1;
        border-style: solid;
        border-width: 1á¹•x;
    }

    video {
        border-color: #f00000;
    }

    #parser {
        border-color: #00f000;
    }

    #result {
        border-color: #0000f0;
    }

    #text {
        margin: 0.5em;
        font-size: 30px;
    }
</style>
</head>
<body>
    <video id="webcam" autoplay="true" loop="true"></video>
    <canvas id="parser"></canvas>
    <canvas id="result"></canvas>
    <div id="text"></div>
</body>
<script type="text/javascript" src="/script.js"></script>
<script type="text/javascript">
    const video = document.querySelector("#webcam");
    const canvas1 = document.querySelector("#parser");
    const canvas2 = document.querySelector("#result");
    const text = document.querySelector("#text");
    var parser = canvas1.getContext("2d");
    var result = canvas2.getContext("2d");

    canvas2.onclick = function() {canvas2.requestFullscreen();}

    var last = null; 

    function draw1() {
        try {
        parser.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        var original = parser.getImageData(0, 0, video.videoWidth, video.videoHeight);
        var frame = parser.getImageData(0, 0, video.videoWidth, video.videoHeight);

        if (last) {
            for (var i = 0; i < frame.data.length; i += 4) {
                frame.data[i] -= last[i];
                frame.data[i + 1] -= last[i + 1];
                frame.data[i + 2] -= last[i + 2];
                if (frame.data[i] < 0) {frame.data[i] *= -1}
                if (frame.data[i + 1] < 0) {frame.data[i + 1] *= -1}
                if (frame.data[i + 2] < 0) {frame.data[i + 2] *= -1}
            }
        }

        last = original.data;
        result.putImageData(frame, 0, 0);
        requestAnimationFrame(draw1);
        } catch (e) {
            alert(e);
        }
    }

    var k = 4;
    var j = 255;
    var n = 20;
    var g = 0;

    function draw() {
        parser.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        var original = parser.getImageData(0, 0, video.videoWidth, video.videoHeight);
        var frame = parser.getImageData(0, 0, video.videoWidth, video.videoHeight);
        var frame2 = parser.getImageData(0, 0, video.videoWidth, video.videoHeight); 

        var t = 4;

        if (last) {
            for (var i = 0; i < frame.data.length; i += 4) {
                if (i + t < frame.data.length) {
                    frame.data[i] -= frame.data[i + t];
                    frame.data[i + 1] -= frame.data[i + 1 + t];
                    frame.data[i + 2] -= frame.data[i + 2 + t];
                } else {
                    frame.data[i] = 0;
                    frame.data[i + 1] = 0;
                    frame.data[i + 2] = 0;
                }

                if (frame.data[i] < 0) {frame.data[i] *= -1}
                if (frame.data[i + 1] < 0) {frame.data[i + 1] *= -1}
                if (frame.data[i + 2] < 0) {frame.data[i + 2] *= -1}

                if (frame.data[i] > k || frame.data[i + 1] > k || frame.data[i + 2] > k) {
                    var m = (original.data[i] + original.data[i + 1] + original.data[i + 2])/3

                    if (m < n) {
                        frame.data[i] = j;
                        frame.data[i + 1] = j;
                        frame.data[i + 2] = j;
                    } else {
                        frame.data[i] = g;
                        frame.data[i + 1] = g;
                        frame.data[i + 2] = g;
                    }
                }
            }

            for (var i = frame2.data.length; i > 0; i -= 4) {
                if (i + t < frame2.data.length) {
                    frame2.data[i] -= frame2.data[i + t];
                    frame2.data[i + 1] -= frame2.data[i + 1 + t];
                    frame2.data[i + 2] -= frame2.data[i + 2 + t];
                } else {
                    frame2.data[i] = 0;
                    frame2.data[i + 1] = 0;
                    frame2.data[i + 2] = 0;
                }

                if (frame2.data[i] < 0) {frame2.data[i] *= -1}
                if (frame2.data[i + 1] < 0) {frame2.data[i + 1] *= -1}
                if (frame2.data[i + 2] < 0) {frame2.data[i + 2] *= -1}

                if (frame2.data[i] > k || frame2.data[i + 1] > k || frame2.data[i + 2] > k) {
                    var m = (original.data[i] + original.data[i + 1] + original.data[i + 2])/3

                    if (m < n) {
                        frame2.data[i] = m;
                        frame2.data[i + 1] = m;
                        frame2.data[i + 2] = m;
                    } else {
                        frame2.data[i] = g;
                        frame2.data[i + 1] = g;
                        frame2.data[i + 2] = g;
                    }
                }
            }
        }

        last = original.data;
        result.putImageData(frame, 0, 0);
        requestAnimationFrame(draw);
    }

    var z = true;
    var x = true;
    var c = true;

    document.body.addEventListener("keypress", function(event) {
        if (event.key == "t") {k += 1}
        if (event.key == "g") {k -= 1}

        if (event.key == "y") {n += 1}
        if (event.key == "h") {n -= 1}

        if (event.key == "u") {g += 1}
        if (event.key == "j") {g -= 1}

        if (event.key == "i") {j += 1}
        if (event.key == "k") {j -= 1}

        text.textContent = "k: " + k + " n: " + n + " g:" + g + " j: " + j;

        if (event.key == "z") {
            z = !z;
            if (z) {video.style.display = "none"} 
            else {video.style.display = ""}
        }
        if (event.key == "x") {
            x = !z;
            if (x) {canvas1.style.display = "none"}
            else {canvas1.style.display = ""}
        }
        if (event.key == "c") {
            c = !c;
            if (c) {canvas2.style.display = "none"}
            else {canvas2.style.display = ""}
        }
    });

   //document.body.onkeypress = function(event) {
   document.body.addEventListener("keypress", function(event) {
        if (event.key != "a") {return};
        navigator.getUserMedia({video: {facingMode: "environment"}, audio: false},
        //navigator.getUserMedia({video: true, audio: false},
            function(stream) {
                video.srcObject = stream;
                video.onplay = function() {
                    canvas1.height = video.videoHeight;
                    canvas1.width = video.videoWidth;
                    canvas2.height = video.videoHeight;
                    canvas2.width = video.videoWidth;
                    requestAnimationFrame(draw);
                    video.playbackRate = 0.5;
                };
            },
            function() {}
        );
    });
    //};

    document.body.addEventListener(function(event) {
        if (event.key != "d") {return};
        video.src = "/video";
        video.onplay = function() {
            canvas1.height = video.videoHeight;
            canvas1.width = video.videoWidth;
            canvas2.height = video.videoHeight;
            canvas2.width = video.videoWidth;
            draw();
            video.playbackRate = 0.5;
        };
    });
</script>
</html>
